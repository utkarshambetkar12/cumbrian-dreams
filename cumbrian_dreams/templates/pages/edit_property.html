{% extends "templates/web.html" %}
{% block page_title %}Edit Property · Cumbrian Dreams{% endblock %}
{% block page_content %}

<style>
  .cd-wrap{max-width:840px;margin:0 auto}
  .cd-card{background:#fff;border:1px solid #eee;border-radius:14px;padding:14px}
  .cd-grid{display:grid;gap:.75rem;grid-template-columns:repeat(auto-fill,minmax(260px,1fr))}
  .cd-input, .cd-textarea, select{width:100%;padding:.5rem .6rem;border-radius:10px;border:1px solid #ddd}
  .cd-textarea{min-height:100px}
  .cd-btn{display:inline-block;border:0;border-radius:10px;padding:.5rem .9rem;text-decoration:none;font-size:.95rem;cursor:pointer}
  .cd-primary{background:#4f46e5;color:#fff}
  .cd-secondary{background:#eef;color:#223}
  .cd-muted{color:#666}.cd-tiny{font-size:.8rem;color:#999}
  .ok{color:#16a34a}.err{color:#e11d48}
</style>

<div class="cd-wrap">
  <div class="cd-card">
    <h2 style="margin:0 0 .5rem 0;">Edit property</h2>
    <div class="cd-tiny cd-muted" style="margin-bottom:.5rem;">
      Updating <strong>{{ item.name }}</strong>
    </div>

    <div class="cd-grid">
      <label>
        <div class="cd-tiny">Title</div>
        <input id="ep-title" class="cd-input" value="{{ item.title }}">
      </label>

      <label>
        <div class="cd-tiny">Price per Night</div>
        <input id="ep-price" class="cd-input" type="number" step="0.01" value="{{ item.price_per_night }}">
      </label>

      <label>
        <div class="cd-tiny">Location</div>
        <input id="ep-location" class="cd-input" value="{{ item.location }}">
      </label>

      {% if is_system_manager %}
      <label>
        <div class="cd-tiny">Host (System Manager only)</div>
        <select id="ep-host" class="cd-input">
          <option value="">(keep current)</option>
          {% for u in users %}
            <option value="{{ u.name }}" {% if item.host == u.name %}selected{% endif %}>
              {{ u.full_name or u.email or u.name }} ({{ u.name }})
            </option>
          {% endfor %}
        </select>
      </label>
      {% endif %}

      <label style="grid-column:1/-1">
        <div class="cd-tiny">Features</div>
        <textarea id="ep-features" class="cd-textarea">{{ item.features }}</textarea>
      </label>

      <label style="grid-column:1/-1">
        <div class="cd-tiny">Rules</div>
        <textarea id="ep-rules" class="cd-textarea">{{ item.rules }}</textarea>
      </label>
    </div>

   <div style="margin-top:.75rem; display:flex; gap:.5rem; flex-wrap: wrap;">
  <button id="ep-save" class="cd-btn cd-primary" type="button">Save Changes</button>
  <a class="cd-btn cd-secondary" href="/my_properties">Back to My Properties</a>
  <a class="cd-btn cd-secondary" href="/property?name={{ item.name }}">View Page</a>

  <!-- NEW: Delete button -->
  <button id="ep-delete" class="cd-btn" type="button" style="background:#fee2e2; color:#991b1b;">
    Delete Property
  </button>
</div>

    <div id="ep-msg" class="cd-muted" style="margin-top:.5rem;"></div>
  </div>
</div>

<script>
/* eslint-env browser */
/* global frappe */
(function(){
  'use strict';
  function byId(id){return document.getElementById(id);}
  function msg(t, cls){ var el=byId('ep-msg'); if(!el) return; el.className=(cls?cls+' ':'')+'cd-muted'; el.textContent=String(t||''); }

  var delBtn = byId('ep-delete');
if (delBtn) {
  delBtn.addEventListener('click', function(){
    if (!confirm('This will permanently delete this property. Are you sure?')) return;
    var csrf = (typeof frappe !== 'undefined' && frappe.csrf_token) ? frappe.csrf_token : '';
    msg('Deleting...');
    fetch('/api/method/cumbrian_dreams.api.delete_property', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-Frappe-CSRF-Token': csrf },
      credentials: 'include',
      body: JSON.stringify({ name: "{{ item.name }}" })
    })
    .then(function(r){ return r.json().then(function(j){ return {status:r.status, body:j}; }); })
    .then(function(resp){
      if (resp.status === 200 && resp.body && (resp.body.ok === true)) {
        msg('Deleted ✅', 'ok');
        setTimeout(function(){ window.location.href = '/my_properties'; }, 600);
      } else {
        var err = (resp.body && (resp.body.message || resp.body._server_messages)) || 'Failed to delete.';
        msg(err, 'err');
      }
    })
    .catch(function(){ msg('Network error while deleting.', 'err'); });
  });
}

  document.addEventListener('DOMContentLoaded', function(){
    var csrf = (typeof frappe !== 'undefined' && frappe.csrf_token) ? frappe.csrf_token : '';
    var btn = byId('ep-save');
    if(!btn) return;

    btn.addEventListener('click', function(){
      var payload = {
        name: "{{ item.name }}",
        title: byId('ep-title').value || '',
        price_per_night: byId('ep-price').value || '',
        location: byId('ep-location').value || '',
        features: byId('ep-features').value || '',
        rules: byId('ep-rules').value || ''
      };
      var hostSel = byId('ep-host');
      if (hostSel) { payload.host = hostSel.value || ''; }

      if(!payload.title || !payload.location){
        msg('Title and Location are required.', 'err'); return;
      }

      msg('Saving...');
      fetch('/api/method/cumbrian_dreams.api.update_property', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-Frappe-CSRF-Token': csrf },
        credentials: 'include',
        body: JSON.stringify(payload)
      })
      .then(function(r){ return r.json().then(function(j){ return {status:r.status, body:j}; }); })
      .then(function(resp){
        if(resp.status >= 400){
          var err = (resp.body && (resp.body.message || resp.body._server_messages)) || 'Failed to update property.';
          msg(err, 'err'); return;
        }
        msg((resp.body && resp.body.message) || 'Updated ✅', 'ok');
        // Optional redirect after a moment
        setTimeout(function(){ window.location.href = '/property?name={{ item.name }}'; }, 800);
      })
      .catch(function(){ msg('Network error while saving.', 'err'); });
    });
  });
})();
</script>

{% endblock %}
